angular.module("rssreader",["ui.router"]).config(["$stateProvider","$urlRouterProvider",function(e,r){r.otherwise("home"),e.state("home",{url:"/home",templateUrl:"./partials/home.html",controller:"HomeController"}).state("login",{url:"/login",templateUrl:"./partials/auth/login.html",controller:"AuthController"}).state("register",{url:"/register",templateUrl:"./partials/auth/register.html",controller:"AuthController"}).state("dashboard",{url:"/dashboard/:id",templateUrl:"./partials/dashboard.html",controller:"DashboardController"}).state("dashboard.addFeed",{url:"/addFeed",templateUrl:"./partials/addFeed.html",controller:"FeedsController"}).state("dashboard.feed",{url:"/feed",templateUrl:"./partials/feed.html",controller:"FeedsController",resolve:{feedPromise:["$stateParams","feedsService",function(e,r){return r.get(e.id)}]}})}]),angular.module("rssreader").controller("AuthController",["$scope","$state","authService","$window",function(e,r,o,t){e.user={},e.session,e.register=function(){o.register(e.user).error(function(r){e.error=r}).then(function(){r.go("home")})},e.logIn=function(){o.logIn(e.user,e.session).error(function(r){e.error=r}).then(function(){e.session?console.log("Checked"):(console.log("Not checked"),e.onExit=function(){auth.logOut()},t.onbeforeunload=e.onExit),r.go("dashboard.feed",{id:o.userID()})})}}]),angular.module("rssreader").controller("DashboardController",["$scope","$state","feedsService","authService",function(e,r,o,t){}]),angular.module("rssreader").controller("FeedsController",["$scope","$state","feedsService","authService",function(e,r,o,t){e.test="Hello world!",e.obj={},e.feeds=o.feeds,e.addFeed=function(){var t=o.addFeed({link:e.obj.link});console.log(t),r.go("dashboard.feed",{},{reload:!0})},e.removeFeed=function(e){o.removeFeed(t.userID(),e),r.reload()}}]),angular.module("rssreader").controller("HomeController",["$scope","$state","authService",function(e,r,o){e.userId=o.userID(),e.header="Welcome to Rss Reader",e.isLoggedIn=o.isLoggedIn,e.currentUser=o.currentUser,e.OnFeeds=function(){o.isLoggedIn()?r.go("dashboard.feed",{id:e.userId}):alert("Unauthtorized")},e.OnRegister=function(){r.go("register")},e.OnLogin=function(){r.go("login")}}]),angular.module("rssreader").controller("NavController",["$scope","$state","authService",function(e,r,o){e.isLoggedIn=o.isLoggedIn,e.currentUser=o.currentUser,e.logOut=function(){o.logOut(),r.go("home")},e.goHome=function(){r.go("home")}}]),angular.module("rssreader").factory("authService",["$http","$window",function(e,r){var o={};return o.saveToken=function(e){r.localStorage["rss-reader-token"]=e},o.getToken=function(){return r.localStorage["rss-reader-token"]},o.isLoggedIn=function(){var e=o.getToken();if(e){var t=JSON.parse(r.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}return!1},o.currentUser=function(){if(o.isLoggedIn()){var e=o.getToken(),t=JSON.parse(r.atob(e.split(".")[1]));return t.email}},o.userID=function(){if(o.isLoggedIn()){var e=o.getToken(),t=JSON.parse(r.atob(e.split(".")[1]));return t._id}},o.register=function(r){return e.post("/register",r).success(function(e){o.saveToken(e.token)})},o.logIn=function(r){return e.post("/login",r).success(function(e){o.saveToken(e.token)})},o.logOut=function(){r.localStorage.removeItem("rss-reader-token")},o}]),angular.module("rssreader").service("feedsService",["$http","authService",function(e,r){var o={feeds:[]};return o.get=function(t){return e.get("/users/"+t,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){angular.copy(e.data.feeds,o.feeds)})},o.addFeed=function(o){e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&q="+o.link+"&callback=JSON_CALLBACK").then(function(o){var t=o.data.responseData.feed;if(null==o.data.responseData)throw new Error("URL is incorrect");console.log("Recieved Feed: "),console.log(t);for(var n={title:t.description,link:t.link,category:"",articles:[],user:r.userID()},s=0;s<t.entries.length;s++){var a={};a.title=t.entries[s].title,a.link=t.entries[s].link,a.content=t.entries[s].contentSnippet,a.date=t.entries[s].publishedDate,n.articles.push(a)}return console.log("Modified Feed: "),console.log(n),e.post("/users/"+r.userID()+"/addFeed",n,{headers:{Authorization:"Bearer "+r.getToken()}}).success(function(e){}),feeds},function(e){console.log(e)})},o.removeFeed=function(o,t){return console.log(t),e["delete"]("/users/"+o+"/deleteFeed/"+t,{headers:{Authorization:"Bearer "+r.getToken()}}).success(function(e){console.log("deleted")})},o}]);