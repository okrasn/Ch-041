angular.module("rssreader",["ui.router","ngValidate","ngFileUpload"]).config(["$stateProvider","$urlRouterProvider",function(e,r){r.otherwise("home"),e.state("home",{url:"/home",templateUrl:"./partials/home.html",controller:"HomeController"}).state("login",{url:"/login",templateUrl:"./partials/auth/login.html",controller:"AuthController",onEnter:["$state","authService",function(e,r){r.isLoggedIn()&&e.go("home")}]}).state("loginAuth",{url:"/loginAuth",templateUrl:"partials/auth/loginAuth.html",controller:"AuthController"}).state("logoutAuth",{url:"/logoutAuth",templateUrl:"partials/auth/logoutAuth.html",controller:"AuthController"}).state("register",{url:"/register",templateUrl:"./partials/auth/register.html",controller:"AuthController",onEnter:["$state","authService",function(e,r){r.isLoggedIn()&&e.go("home")}]}).state("profile",{url:"/profile",templateUrl:"./partials/auth/profile.html",controller:"ProfileController"}).state("dashboard",{url:"/dashboard",views:{"":{templateUrl:"./partials/dashboard/dashboard.html",controller:"DashboardController"},"sidebar@dashboard":{templateUrl:"./partials/dashboard/sidebar.html",controller:"SidebarController"},"feedHead@dashboard":{templateUrl:"./partials/dashboard/feed-head.html",controller:"DashboardController"}},resolve:{feedPromise:["feedsService",function(e){return e.getAllFeeds()}],articlesPromise:["articlesService",function(e){return e.getAllArticles()}]}}).state("dashboard.th-large",{url:"/th-large",templateUrl:"./partials/list/th-large.html",controller:"ArticlesController"}).state("dashboard.list",{url:"/list",templateUrl:"./partials/list/list.html",controller:"ArticlesController"}).state("dashboard.th-list",{url:"/th-list",templateUrl:"./partials/list/th-list.html",controller:"ArticlesController"}).state("dashboard.addFeed",{url:"/add",templateUrl:"./partials/dashboard/add-feed.html",controller:"FeedsController",resolve:{dashboardPromise:["dashboardService",function(e){return e.setTitle("Add Feed")}]}})}]),angular.module("rssreader").controller("ArticlesController",["$scope","$state","articlesService",function(e,r,t){e.articles=t.articles}]),angular.module("rssreader").controller("AuthController",["$scope","$state","authService","$window","dashboardService",function(e,r,t,o,a){e.user={},e.session;var l={field_required:"This field is required",email_example:"Please, use example: jacksparrow@gmail.com",char_num6_required:"Please, enter at least 6 characters",char_num9_required:"Please, enter at least 9 characters",char_num20_required:"Please, enter at least 20 characters"};e.register=function(o){console.log(e.user),o.validate()&&t.register(e.user).error(function(r){e.error=r}).then(function(){r.go("dashboard."+a.currentView,{id:t.userID()})})},e.logIn=function(l){l.validate()&&t.logIn(e.user,e.session).error(function(r){e.error=r}).then(function(){e.session?(console.log("GO@!0"),r.go("dashboard."+a.currentView,{id:t.userID()})):(e.onExit=function(){auth.logOut()},r.go("dashboard."+a.currentView,{id:t.userID()}),o.onbeforeunload=e.onExit)})},e.validationLoginOptions={rules:{mail:{required:!0,email:!0},pwd:{required:!0}},messages:{mail:{required:l.field_required,email:l.email_example},pwd:{required:l.field_required}}},e.validationRegistrOptions={rules:{mail:{required:!0,email:!0,minlength:9,maxlength:20},pwd:{required:!0,minlength:6,maxlength:20},reppwd:{required:!0,minlength:6,maxlength:20}},messages:{mail:{required:l.field_required,email:l.email_example,minlength:l.char_num9_required,maxlength:l.char_num20_required},pwd:{required:l.field_required,minlength:l.char_num6_required,maxlength:l.char_num20_required},reppwd:{required:l.field_required,minlength:l.char_num6_required,maxlength:l.char_num20_required}}}}]),angular.module("rssreader").controller("DashboardController",["$scope","$state","dashboardService","feedsService",function(e,r,t,o){e.headTitle=t.getTitle,e.feed=t.getFeedId,e.hideViewBtns=function(){return"Add Feed"===e.headTitle()},e.onViewChange=function(e){t.currentView=e,r.go("dashboard."+t.currentView)},e.onFeedDelete=function(){o.removeFeed(t.currentFeed)}}]),angular.module("rssreader").controller("FeedsController",["$scope","$state","feedsService","dashboardService",function(e,r,t,o){e.test="Hello world!",e.obj={},e.feeds=t.feedsDictionary,e.categories=t.CATEGORIES,e.addFeed=function(){e.error="",t.addFeed(e.obj).then(function(e){r.reload("dashboard"),r.go("dashboard."+o.currentView),o.setTitle("All")},function(r){console.log(r),r.data?e.error=r.data.message:e.error=r.message})}}]),angular.module("rssreader").controller("HomeController",["$scope","$state","authService","dashboardService","articlesService",function(e,r,t,o,a){e.isLoggedIn=t.isLoggedIn,e.currentUser=t.currentUser,e.OnFeeds=function(){a.getAllArticles(),console.log(a.articles),t.isLoggedIn()?0==a.articles.length?(console.log("Empty"),r.go("dashboard.addFeed")):r.go("dashboard."+o.currentView,{id:t.userID()}):alert("Unauthtorized")},e.OnRegister=function(){r.go("register")},e.OnLogin=function(){r.go("login")}}]),angular.module("rssreader").controller("IndexController",["$scope","$state","authService","$window","themeService",function(e,r,t,o,a){e.layout=a.getTheme,e.text="some text"}]),angular.module("rssreader").controller("NavbarController",["$scope","$state","authService",function(e,r,t){e.isLoggedIn=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=function(){t.logOut(),r.go("home")},e.goHome=function(){e.isLoggedIn()?r.go("dashboard"):r.go("home")}}]),angular.module("rssreader").controller("ProfileController",["Upload","profileService","$scope","authService","$window","themeService",function(e,r,t,o,a,l){t.submit=function(){console.log(t.file),t.upload_form.file.$valid&&t.file&&t.upload(t.file)},t.upload=function(r){e.upload({url:"http://localhost:8080/upload",headers:{Authorization:"Bearer "+o.getToken()},data:{file:r}}).then(function(e){0===e.data.error_code?a.alert("Success "+e.config.data.file.name+"uploaded. Response: "):a.alert("an error occured")},function(e){console.log("Error status: "+e.status),a.alert("Error status: "+e.status)},function(e){console.log(e);var r=parseInt(100*e.loaded/e.total);console.log("progress: "+r+"% "+e.config.data.file.name),t.progress="progress: "+r+"% "})},t.user=o.currentUser,t.updateTheme=function(){l.layout=t.layout,console.log("Theme update"),console.log("Theme:"+l.layout)},t.layout=l.layout,t.layouts=l.layouts}]),angular.module("rssreader").controller("SidebarController",["$scope","$state","feedsService","articlesService","dashboardService",function(e,r,t,o,a){e.feeds=t.feedsDictionary,e.getAll=function(){1===e.feeds.length&&1===e.feeds[0].values.length?e.getByFeed(e.feeds[0].values[0]._id,e.feeds[0].values[0].title):o.getAllArticles(),r.go("dashboard."+a.currentView)},e.getByFeed=function(e){o.getArticlesByFeed(e),r.go("dashboard."+a.currentView)},e.getByCat=function(t,l){1==e.feeds[l].values.length?e.getByFeed(e.feeds[l].values[0]):o.getArticlesByCat(t),r.go("dashboard."+a.currentView)}}]),angular.module("rssreader").service("articlesService",["$http","authService","dashboardService",function(e,r,t){var o={articles:[]},a=10;return o.getAllArticles=function(){o.articles.length=0,t.setTitle("All"),t.resetFeedId();var l="all";return e.get("/users/"+r.userID()+"/articles/"+l+"/"+a,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){angular.forEach(e.data,function(e,r){angular.forEach(e.articles,function(e,r){o.articles.push(e)})})})},o.getArticlesByFeed=function(l){o.articles.length=0,t.setTitle(l.title),t.setFeedId(l._id);var n="feed";return e.get("/users/"+r.userID()+"/articles/"+n+"/"+l._id+"/"+a,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){angular.copy(e.data.articles,o.articles)})},o.getArticlesByCat=function(l){o.articles.length=0,t.setTitle(l),t.resetFeedId();var n="category";return e.get("/users/"+r.userID()+"/articles/"+n+"/"+l+"/"+a,{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){console.log("All articles for category "+l+" recieved: "),angular.forEach(e.data,function(e,r){angular.forEach(e.articles,function(e,r){o.articles.push(e)})})})},o}]),angular.module("rssreader").factory("authService",["$http","$window",function(e,r){var t={};return t.saveToken=function(e){r.localStorage["rss-reader-token"]=e},t.getToken=function(){return r.localStorage["rss-reader-token"]},t.isLoggedIn=function(){var e=t.getToken();if(e){var o=JSON.parse(r.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},t.currentUser=function(){if(t.isLoggedIn()){var e=t.getToken(),o=JSON.parse(r.atob(e.split(".")[1]));return o.email}},t.userID=function(){if(t.isLoggedIn()){var e=t.getToken(),o=JSON.parse(r.atob(e.split(".")[1]));return o._id}},t.register=function(r){return e.post("/register",r).success(function(e){t.saveToken(e.token)}).error(function(e){console.log(e.message)})},t.logIn=function(r){return e.post("/login",r).success(function(e){t.saveToken(e.token)}).error(function(e){console.log(e.message)})},t.logOut=function(){r.localStorage.removeItem("rss-reader-token")},t}]),angular.module("rssreader").service("dashboardService",function(){this.DEFAULT_VIEW="th-large",that=this,this.title="",this.setTitle=function(e){"Add Feed"==e&&this.resetFeedId(),that.title=e},this.getTitle=function(){return that.title},this.currentView=this.DEFAULT_VIEW,this.currentFeed="",this.getFeedId=function(){return that.currentFeed},this.setFeedId=function(e){that.currentFeed=e},this.resetFeedId=function(){that.currentFeed=""}}),angular.module("rssreader").service("feedsService",["$http","$state","authService","dashboardService",function(e,r,t,o){var a=20,l={feedsDictionary:[],allArticles:[],CATEGORIES:["News","IT","Sport","Design","Movies","Music","Culture","Nature","Economics","Science"]};return l.getAllFeeds=function(){return e.get("/users/"+t.userID(),{headers:{Authorization:"Bearer "+t.getToken()}}).then(function(e){angular.copy(e.data,l.feedsDictionary)})},l.addFeed=function(r){return e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num="+a+"&q="+encodeURIComponent(r.link)+"&method=JSON&callback=JSON_CALLBACK").then(function(o){if(void 0===r.category)throw new Error("Choose category");if(null===o.data.responseData)throw new Error("URL is incorrect or does not contain RSS Feed data");var a,l={};a=o.data.responseData.feed,l.title=a.description||a.title,l.link=a.link,l.category=r.category,l.articles=[],l.user=t.userID();for(var n=0;n<a.entries.length;n++){var i={},s=document.createElement("content");s.innerHTML=a.entries[n].content;var d;d=void 0===$(s).find("img")[0]?"":$(s).find("img")[0].src,i.title=a.entries[n].title,i.link=a.entries[n].link,i.content=a.entries[n].contentSnippet,i.img=d,i.date=a.entries[n].publishedDate,l.articles.push(i)}return e.post("/users/"+t.userID()+"/addFeed",l,{headers:{Authorization:"Bearer "+t.getToken()}})},function(e){console.log(e)})},l.removeFeed=function(a){return e["delete"]("/users/"+t.userID()+"/deleteFeed/"+a,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){r.reload("dashboard"),r.go("dashboard."+o.currentView)})},l}]),angular.module("rssreader").service("profileService",["$window","Upload",function(e,r){}]),angular.module("rssreader").service("themeService",["authService","$window",function(e,r){that=this,this.layout="style",this.getTheme=function(){return void 0!==that.layout?that.layout:"style"},this.layouts=[{name:"Blue",url:"style"},{name:"Black",url:"style2"},{name:"Grey",url:"style3"}]}]);