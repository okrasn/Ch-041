angular.module("rssreader",["ui.router","ngValidate","ngFileUpload","favicon"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("home"),e.state("home",{url:"/home",templateUrl:"./partials/home.html",controller:"HomeController"}).state("login",{url:"/login",templateUrl:"./partials/auth/login.html",controller:"AuthController",onEnter:["$state","authService",function(e,t){t.isLoggedIn()&&e.go("home")}]}).state("loginAuth",{url:"/loginAuth",templateUrl:"partials/auth/loginAuth.html",controller:"AuthController"}).state("logoutAuth",{url:"/logoutAuth",templateUrl:"partials/auth/logoutAuth.html",controller:"AuthController"}).state("register",{url:"/register",templateUrl:"./partials/auth/register.html",controller:"AuthController",onEnter:["$state","authService",function(e,t){t.isLoggedIn()&&e.go("home")}]}).state("profile",{url:"/profile",templateUrl:"./partials/auth/profile.html",controller:"ProfileController",onEnter:["$state","authService",function(e,t){t.isLoggedIn()||(t.logOut(),e.go("home"))}]}).state("dashboard",{url:"/dashboard",views:{"":{templateUrl:"./partials/dashboard/dashboard.html",controller:"DashboardController"},"sidebar@dashboard":{templateUrl:"./partials/dashboard/sidebar.html",controller:"SidebarController"},"feedHead@dashboard":{templateUrl:"./partials/dashboard/feed-head.html",controller:"DashboardController"}},resolve:{feedPromise:["feedsService",function(e){return console.log("resolveFeeds"),e.getAllFeeds()}]},onEnter:["articlesService","dashboardService","feedsService","$state","authService",function(e,t,r,o,n){console.log("OnEnter"),e.getAllArticles()}]}).state("dashboard.list",{url:"/list",templateUrl:"./partials/list/list.html",controller:"ArticlesController"}).state("dashboard.th-list",{url:"/th-list",templateUrl:"./partials/list/th-list.html",controller:"ArticlesController"}).state("dashboard.th-large",{url:"/th-large",templateUrl:"./partials/list/th-large.html",controller:"ArticlesController"}).state("dashboard.addFeed",{url:"/add",templateUrl:"./partials/dashboard/add-feed.html",controller:"FeedsController",onEnter:["dashboardService",function(e){e.setTitle("Add Feed")}]})}]),function(){"use strict";angular.module("rssreader").controller("ArticlesController",["$scope","$state","articlesService","dashboardService",function(e,t,r,o){e.articles=r.articles,e.isFavourites=r.checkIfFavourites,e.addFavourite=function(e){r.addFavourite(e).then(function(e){t.reload("dashboard")},function(e){console.log(e.data.message)})},e.removeFavourite=function(e){r.removeFavourite(e).then(function(e){t.reload("dashboard")},function(e){console.log(e)})}}])}(),function(){"use strict";angular.module("rssreader.directives").config(["$validatorProvider",function(e){e.addMethod("pattern",function(e,t){return this.optional(t)||/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*(_|[^\w])).{6,20}/.test(e)},"Please specify the correct domain for your documents")}]).controller("AuthController",["$scope","$state","authService","$window","dashboardService",function(e,t,r,o,n){e.user={},e.session;var a={field_required:"This field is required",email_example:"Please, use example: jacksparrow@gmail.com",min_6symbl:"Please, enter at least 6 characters",min_9symbl:"Please, enter at least 9 characters",max_20symbl:"Please, enter no more then 20 characters",reg_exp:"Requirements: minimum 1 of each chars (a-z,A-Z,0-9,!@#...)"};e.register=function(o){o.validate()&&r.register(e.user).error(function(t){e.error=t}).then(function(){t.go("dashboard."+n.currentView,{id:r.userID()})})},e.logIn=function(a){a.validate()&&r.logIn(e.user,e.session).error(function(t){e.error=t}).then(function(){e.session?t.go("dashboard."+n.currentView,{id:r.userID()}):(e.onExit=function(){auth.logOut()},t.go("dashboard."+n.currentView,{id:r.userID()}),o.onbeforeunload=e.onExit)})},e.validationLoginOptions={rules:{mail:{required:!0,email:!0},pwd:{required:!0}},messages:{mail:{required:a.field_required,email:a.email_example},pwd:{required:a.field_required}}},e.validationRegistrOptions={rules:{mail:{required:!0,email:!0,minlength:9,maxlength:20},pwd:{required:!0,minlength:6,maxlength:20,pattern:!0},reppwd:{required:!0}},messages:{mail:{required:a.field_required,email:a.email_example,minlength:a.min_9symbl,maxlength:a.max_20symbl},pwd:{required:a.field_required,minlength:a.min_6symbl,maxlength:a.max_20symbl,pattern:a.reg_exp},reppwd:{required:a.field_required}}}}]).directive("checkStrength",function(){return{replace:!1,restrict:"EACM",link:function(e,t,r){var o={colors:["#F00","#F90","#FF0","#9F0","#0F0"],mesureStrength:function(e){var t=0,r=/[$-\/:-?{-~!"^_`\[\]]/g,o=/[a-z]+/.test(e),n=/[A-Z]+/.test(e),a=/[0-9]+/.test(e),i=r.test(e),s=[o,n,a,i],l=$.grep(s,function(e){return e===!0}).length;return t+=2*e.length+(e.length>=10?1:0),t+=10*l,t=e.length<=6?Math.min(t,10):t,t=1==l?Math.min(t,10):t,t=2==l?Math.min(t,20):t,t=3==l?Math.min(t,40):t},getColor:function(e){var t=0;return t=e<=10?0:e<=20?1:e<=30?2:e<=40?3:4,{idx:t+1,col:this.colors[t]}}};e.$watch(r.checkStrength,function(){if(""===e.pw)t.css({display:"none"});else{var r=o.getColor(o.mesureStrength(e.pw));t.css({display:"inline"}),t.children("li").css({background:"#DDD"}).slice(0,r.idx).css({background:r.col})}})},template:'<li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li>'}})}(),function(){"use strict";angular.module("rssreader").controller("DashboardController",["$scope","$state","dashboardService","feedsService",function(e,t,r,o){o.feedsDictionary.length?(r.setTitle("All"),t.go("dashboard."+r.getViewMode())):(r.setTitle("Add Feed"),t.go("dashboard.addFeed")),e.headTitle=r.getTitle,e.feed=r.getFeedId,e.hideViewBtns=function(){return"Add Feed"===e.headTitle()||0==o.feedsDictionary.length},e.checkIfToggled=function(e){return r.getViewMode()===e},e.onViewChange=function(e){switch(e){case"view-mode1":r.setViewMode(0);break;case"view-mode2":r.setViewMode(1);break;case"view-mode3":r.setViewMode(2)}t.go("dashboard."+r.getViewMode())},e.onFeedDelete=function(){o.removeFeed(r.getFeedId()).then(function(e){t.reload("dashboard")},function(e){console.log(e)})}}])}(),function(){"use strict";angular.module("rssreader").controller("FeedsController",["$scope","$state","$http","feedsService","dashboardService","articlesService","authService",function(e,t,r,o,n,a,i){e.obj={},e.feeds=o.feedsDictionary,e.categories=o.CATEGORIES,e.addFeed=function(){e.error="",o.addFeed(e.obj).then(function(e){t.reload("dashboard")},function(t){console.log(t),t.data?e.error=t.data.message:e.error=t.message})}}])}(),function(){"use strict";angular.module("rssreader").controller("HomeController",["$scope","$state","authService","dashboardService","feedsService",function(e,t,r,o,n){e.isLoggedIn=r.isLoggedIn,e.currentUser=r.currentUser,e.OnFeeds=function(){console.log(o.getViewMode()),r.isLoggedIn()?t.go("dashboard."+o.getViewMode(),{id:r.userID()}):alert("Unauthtorized")},e.OnRegister=function(){t.go("register")},e.OnLogin=function(){t.go("login")}}])}(),function(){"use strict";angular.module("rssreader").controller("IndexController",["$scope","$state","authService","$window","themeService",function(e,t,r,o,n){e.layout=n.getTheme,e.text="some text"}])}(),function(){"use strict";angular.module("rssreader").controller("NavbarController",["$scope","$state","authService",function(e,t,r){e.isLoggedIn=r.isLoggedIn,e.currentUser=r.currentUser,e.logOut=function(){r.logOut(),t.go("home")},e.goHome=function(){e.isLoggedIn()?t.go("dashboard"):t.go("home")}}])}(),function(){"use strict";angular.module("rssreader").config(["$validatorProvider",function(e){e.addMethod("pattern",function(e,t){return this.optional(t)||/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*(_|[^\w])).{6,20}/.test(e)},"Please specify the correct domain for your documents")}]).controller("ProfileController",["Upload","$http","$state","profileService","$scope","authService","$window","themeService","dashboardService",function(e,t,r,o,n,a,i,s,l){n.currentUser=a.currentUser(),n.newUserData={email:a.currentUser(),currentPass:"",newPass:"",newPassRepeat:""};var d={field_required:"This field is required",email_example:"Please, use example: jacksparrow@gmail.com",min_6symbl:"Please,enter at least 6 characters",min_9symbl:"Please,enter at least 9 characters",max_20symbl:"Please,no more then 20 characters",reg_exp:"1 of each symbl (a-z,A-Z,0-9,!@#...)"};n.changePass=function(e){if(e.validate())return console.log("Submit change password"),t.post("/changePassword",n.newUserData,{headers:{Authorization:"Bearer "+a.getToken()}}).success(function(e){a.saveToken(e.token),r.go("dashboard."+l.getViewMode(),{id:a.userID()})}).error(function(e){n.err=e,console.log(e.message)})},n.changePassValidation={rules:{currentPassword:{required:!0},newPassword:{required:!0,minlength:6,maxlength:20,pattern:!0},repeatNewPassword:{required:!0}},messages:{currentPassword:{required:d.field_required,email:d.email_example,minlength:d.min_9symbl,maxlength:d.max_20symbl},newPassword:{required:d.field_required,minlength:d.min_6symbl,maxlength:d.max_20symbl,pattern:d.reg_exp},repeatNewPassword:{required:d.field_required}}},n.updateTheme=function(){s.layout=n.layout,console.log("Theme update"),console.log("Theme:"+s.layout)},n.layout=s.layout,n.layouts=s.layouts}]).directive("pwCheck",[function(){return{require:"ngModel",link:function(e,t,r,o){var n="#"+r.pwCheck;t.add(n).on("keyup",function(){e.$apply(function(){if(""!==t.val()){var e=t.val()===$(n).val();o.$setValidity("pwmatch",e)}})})}}}])}(),function(){"use strict";angular.module("rssreader").controller("SidebarController",["$scope","$state","feedsService","articlesService","dashboardService",function(e,t,r,o,n){e.feeds=r.feedsDictionary,e.favs=r.favourites,e.getAll=function(){console.log("getAll"),1===e.feeds.length&&1===e.feeds[0].values.length?e.getByFeed(e.feeds[0].values[0]):o.getAllArticles(),t.go("dashboard."+n.getViewMode())},e.getByFeed=function(e){o.getArticlesByFeed(e),t.go("dashboard."+n.getViewMode())},e.getByCat=function(r,a){1==e.feeds[a].values.length?e.getByFeed(e.feeds[a].values[0]):o.getArticlesByCat(r),t.go("dashboard."+n.getViewMode())},e.getFavourites=function(){o.getFavourites(),t.go("dashboard."+n.getViewMode())},e.getFavArticle=function(e){o.getFavArticle(e),t.go("dashboard."+n.getViewMode())},e.hideFavourites=function(){return e.favs.length},e.checkIfEmpty=function(){return 0!=r.feedsDictionary.length},e.toggle=!1}])}(),angular.module("rssreader").service("articlesService",["$http","$q","authService","$timeout","dashboardService","feedsService",function(e,t,r,o,n,a){var i={articles:[],isFavourites:!1},s=50,l=function(t){return e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num="+s+"&q="+encodeURIComponent(t.rsslink)+"&method=JSONP&callback=JSON_CALLBACK&output=xml").then(function(e){var r=new DOMParser,o=r.parseFromString(e.data.responseData.xmlString,"text/xml"),n=[];if("RSS"===t.format){n=o.getElementsByTagName("item");for(var a=0;a<n.length;a++){var s={};if(s.title=n[a].getElementsByTagName("title")[0].innerHTML,s.link=n[a].getElementsByTagName("link")[0].textContent,n[a].getElementsByTagName("enclosure").length)s.img=n[a].getElementsByTagName("enclosure")[0].getAttribute("url");else{var l={src:""};try{l.src=$(n[a].getElementsByTagName("description")[0].textContent).find("img")[0].src}catch(d){l.src=""}s.img=l.src}var c=document.createElement("div");c.innerHTML=n[a].getElementsByTagName("description")[0].textContent,s.content=$(c).text(),s.date=n[a].getElementsByTagName("pubDate")[0].textContent,i.articles.push(s)}}else if("ATOM"===t.format){n=o.getElementsByTagName("entry");for(var a=0;a<n.length;a++){var s={},u=$.parseHTML(n[a].getElementsByTagName("content")[0].childNodes[0].data)[0].src;void 0===u&&(u=""),s.img=u,s.title=n[a].getElementsByTagName("title")[0].textContent,s.link=n[a].getElementsByTagName("id")[0].textContent,s.content=$(n[a].getElementsByTagName("content")[0].childNodes[0].data).text(),s.date=n[a].getElementsByTagName("published")[0].textContent,i.articles.push(s)}}},function(e){console.log(e)})};return i.checkIfFavourites=function(){return i.isFavourites},i.getAllArticles=function(){console.log("all"),i.isFavourites=!1,i.articles.length=0,n.setTitle("All"),n.resetFeedId(),angular.forEach(a.feedsDictionary,function(e,t){angular.forEach(e.values,function(e,t){return l(e).then(function(e){console.log("res")})})})},i.getArticlesByFeed=function(e){i.isFavourites=!1,i.articles.length=0,n.setTitle(e.title),n.setFeedId(e._id),l(e)},i.getArticlesByCat=function(e){i.isFavourites=!1,i.articles.length=0,n.setTitle(e),n.resetFeedId(),angular.forEach(a.feedsDictionary,function(t,r){t.key===e&&angular.forEach(t.values,function(e,t){l(e)})})},i.getFavourites=function(){i.isFavourites=!0,i.articles.length=0,n.setTitle("Favourites"),n.resetFeedId(),console.log(a.favourites),angular.copy(a.favourites,i.articles)},i.getFavArticle=function(e){i.isFavourites=!0,n.setTitle("Favourites"),n.resetFeedId(),i.articles.length=0,i.articles.push(e)},i.addFavourite=function(t){return e.post("/users/"+r.userID()+"/addFavArticle",t,{headers:{Authorization:"Bearer "+r.getToken()}})},i.removeFavourite=function(t){return e["delete"]("/users/"+r.userID()+"/deleteFavFeed/"+t._id,{headers:{Authorization:"Bearer "+r.getToken()}})},i}]),angular.module("rssreader").factory("authService",["$http","$window",function(e,t){var r={};return r.saveToken=function(e){t.localStorage["rss-reader-token"]=e},r.getToken=function(){return t.localStorage["rss-reader-token"]},r.isLoggedIn=function(){var e=r.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},r.currentUser=function(){if(r.isLoggedIn()){var e=r.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o.email}},r.userID=function(){if(r.isLoggedIn()){var e=r.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o._id}},r.register=function(t){return e.post("/register",t).success(function(e){r.saveToken(e.token)}).error(function(e){console.log(e.message)})},r.logIn=function(t){return e.post("/login",t).success(function(e){r.saveToken(e.token)}).error(function(e){console.log(e.message)})},r.logOut=function(){t.localStorage.removeItem("rss-reader-token")},r}]),angular.module("rssreader").service("dashboardService",[function(){var e=this;this.DEFAULT_VIEW=2,this.currentViewMode=e.DEFAULT_VIEW,this.viewModes=["list","th-list","th-large"],this.resetViewMode=function(){e.currentViewMode=e.DEFAULT_VIEW},this.setViewMode=function(t){if(t>e.viewModes.length-1)throw new Error("View mode you are trying to set is not defined");e.currentViewMode=t},this.getViewMode=function(){return e.viewModes[e.currentViewMode]},this.title="",this.setTitle=function(t){"Add Feed"==t&&this.resetFeedId(),e.title=t},this.getTitle=function(){return e.title},this.currentView=this.DEFAULT_VIEW,this.currentFeed="",this.getFeedId=function(){return e.currentFeed},this.setFeedId=function(t){e.currentFeed=t},this.resetFeedId=function(){e.currentFeed=""}}]),angular.module("rssreader").service("feedsService",["$http","$state","authService","dashboardService",function(e,t,r,o){that=this,this.feedsDictionary=[],this.favourites=[],this.allArticles=[],this.CATEGORIES=["News","IT","Sport","Design","Movies","Music","Culture","Nature","Economics","Science"],this.getAllFeeds=function(){return console.log("feeds"),e.get("/users/"+r.userID(),{headers:{Authorization:"Bearer "+r.getToken()}}).then(function(e){angular.copy(e.data,that.feedsDictionary),console.log("dictionary:"),console.log(that.feedsDictionary),that.getAllFavourites().then(function(e){angular.copy(e.data,that.favourites)})})},this.getAllFavourites=function(){return e.get("/users/"+r.userID()+"/favourites",{headers:{Authorization:"Bearer "+r.getToken()}})};var n=function(e){return e.getElementsByTagName("rss").length?"RSS":e.getElementsByTagName("feed").length?"ATOM":-1},a=function(e,t,r){var o={};if("RSS"===r){var n=e.getElementsByTagName("channel")[0];o.title=n.getElementsByTagName("title")[0].childNodes[0].nodeValue,o.description=n.getElementsByTagName("description")[0].childNodes[0].nodeValue,o.link=n.getElementsByTagName("link")[0].childNodes[0].nodeValue,o.rsslink=t.link,o.category=t.category}else"ATOM"===r&&(o.title=e.getElementsByTagName("title")[0].childNodes[0].nodeValue,o.description="",o.link=e.getElementsByTagName("link")[0].getAttribute("href"),o.rsslink=t.link,o.category=t.category);return o.format=r,console.log("result:"),console.log(o),o};this.addFeed=function(t){return e.jsonp("https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&q="+encodeURIComponent(t.link)+"&method=JSON&callback=JSON_CALLBACK&output=xml").then(function(o){if(void 0===t.category)throw new Error("Choose category");if(null===o.data.responseData)throw new Error("URL is incorrect or does not contain RSS Feed data");console.log("XML:");var i=new DOMParser,s=i.parseFromString(o.data.responseData.xmlString,"text/xml");console.log(s);var l=n(s,t,l);if(l===-1)throw new Error("URL is incorrect or does not contain RSS Feed data");var d=a(s,t,l);return console.log("feedObj:"),console.log(d),e.post("/users/"+r.userID()+"/addFeed",d,{headers:{Authorization:"Bearer "+r.getToken()}})},function(e){console.log(e)})},this.removeFeed=function(t){return e["delete"]("/users/"+r.userID()+"/deleteFeed/"+t,{headers:{Authorization:"Bearer "+r.getToken()}})}}]),angular.module("rssreader").service("profileService",["$window","Upload",function(e,t){}]),angular.module("rssreader").service("themeService",["authService","$window",function(e,t){that=this,this.layout="style",this.getTheme=function(){return void 0!==that.layout?that.layout:"style"},this.layouts=[{name:"Blue",url:"style"},{name:"Black",url:"style2"},{name:"Grey",url:"style3"}]}]);